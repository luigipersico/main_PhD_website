<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Trapped Particles and Fast Ion Stability – Luigi Persico - Ph.D.</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-c41aa1d2275792d6198d438d2c1382bc.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar docked fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Courses</li><li class="breadcrumb-item"><a href="../../../Courses/Plasma_Instabilities/01_MHD_model.html">Plasma Instabilities</a></li><li class="breadcrumb-item"><a href="../../../Courses/Plasma_Instabilities/Exam_victus/Exercise6.html">Exam Victus</a></li><li class="breadcrumb-item"><a href="../../../Courses/Plasma_Instabilities/Exam_victus/Exercise7.html">Trapped Particles and Fast Ion Stability</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="../../../index.html" class="sidebar-logo-link">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../project-roadmap.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Ph.D.&nbsp;roadmap</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Courses</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Plasma Instabilities</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../Courses/Plasma_Instabilities/01_MHD_model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The MHD model</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../Courses/Plasma_Instabilities/02_Grad_Shafranov.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Grad Shafranov equation</span></a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Exam Victus</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth3 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../Courses/Plasma_Instabilities/Exam_victus/Exercise6.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Ballooning Modes and Weird Curvature</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../Courses/Plasma_Instabilities/Exam_victus/Exercise7.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Trapped Particles and Fast Ion Stability</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Papers</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../papers/Paper1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Paper1</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Reports</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../reports/2025-09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">September 2025</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../reports/2025-10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">October 2025</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../reports/2025-11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">November 2025</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../reports/2025-12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">December 2025</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Theory</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="false">
 <span class="menu-text">Mathematic Tools</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../theory/Mathematic_tools/Bra-ket_notation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bra-ket notation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../theory/Mathematic_tools/covariant_contravariant.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Covariant and Contravariant</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../theory/Mathematic_tools/Hermitian_adjoint.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hermitian adjoint</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../theory/Mathematic_tools/Hilbert_Space.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Hilbert Space</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../theory/Mathematic_tools/Pauli_matrices.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pauli matrices</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="false">
 <span class="menu-text">Plasma Physics</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../theory/Plasma_physics/BES.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Beam Emission Spectroscopy (BES)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../theory/Plasma_physics/MSE.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Motional-Stark Effect (MSE)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../theory/Plasma_physics/NBI.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Neutral Beam Injector (NBI)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../theory/Plasma_physics/NBI_simulator.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">NBI Simulation: Mathematical Model &amp; Code Implementation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../theory/Plasma_physics/Optical_spectrometer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Optical Spectrometer</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../theory/Plasma_physics/Optics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Optics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../theory/Plasma_physics/Safety_factor.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Safety Factor q</span></a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="false">
 <span class="menu-text">Diagnostics</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth3 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../theory/Plasma_physics/Diagnostics/PD.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Photodiodes (PD)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../theory/Plasma_physics/Diagnostics/thomson.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Thomson scattering system</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" role="navigation" aria-expanded="false">
 <span class="menu-text">Quantum Physics</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-10" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../theory/Quantum_physics/Quantum_entanglement.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Quatum Entanglement</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../theory/Quantum_physics/Schrödinger_eq.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Schrödinger Equation</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" role="navigation" aria-expanded="false">
 <span class="menu-text">Useful Guides</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-11" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../theory/Useful_guides/Controlling_CMOS_cameras.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">How to control CMOS cameras</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../theory/Useful_guides/Controlling_MSS.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">How to control MSS</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Courses</li><li class="breadcrumb-item"><a href="../../../Courses/Plasma_Instabilities/01_MHD_model.html">Plasma Instabilities</a></li><li class="breadcrumb-item"><a href="../../../Courses/Plasma_Instabilities/Exam_victus/Exercise6.html">Exam Victus</a></li><li class="breadcrumb-item"><a href="../../../Courses/Plasma_Instabilities/Exam_victus/Exercise7.html">Trapped Particles and Fast Ion Stability</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Trapped Particles and Fast Ion Stability</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="exercise-statement" class="level2">
<h2 class="anchored" data-anchor-id="exercise-statement">Exercise Statement</h2>
<ol start="7" type="1">
<li>For an isotropic distribution of fast ions <span class="math inline">\(F_h(\mathcal{E}, r)\)</span>:</li>
</ol>
<p><strong>(a) Show</strong> that the fraction of trapped ions is <em>exactly</em> (the result holding in any magnetic configuration, e.g.&nbsp;3D though in thin banana limit): <span class="math display">\[
    f_t = \left( 1 - \frac{B}{B_{max}} \right)^{1/2}
    \]</span> and <strong>describe</strong> the meaning of <span class="math inline">\(B_{max}\)</span>.</p>
<p><strong>(b) Assume</strong> now a large aspect ratio axisymmetric tokamak (or reverse field pinch), <strong>show</strong> that the local trapped fraction is approximately, <span class="math display">\[
    f_t = \epsilon^{1/2} (1 + \cos \Theta)^{1/2}
    \]</span> and <strong>discuss</strong> the trapped fraction on the outboard side (low field side), the inboard side (high field side) and calculate the approximate flux surface average value, <span class="math display">\[
    \overline{f_t} = \frac{1}{2\pi} \int_{-\pi}^{\pi} d\Theta f_t.
    \]</span></p>
<p><strong>(c)</strong> The solution to the drift kinetic equation for the perturbed distribution function in the limit of large bounce and transit frequency is quoted in the lecture notes to be approximately, <span class="math display">\[
    \delta F_h = - \boldsymbol{\xi} \cdot \nabla F_h + \begin{cases} q_j \langle \phi \rangle \xi^\psi \frac{\partial F_h}{\partial \mathcal{E}} \frac{(\omega - n\omega_{*h})}{\omega - n\langle \dot{\phi} \rangle + i \nu_{eff}} &amp; \text{trapped ions} \\ 0 &amp; \text{passing ions}, \end{cases}
    \]</span> where <span class="math display">\[
    \omega_{*h} = q_j^{-1} \frac{\partial F_h}{\partial \psi} \bigg/ \frac{\partial F_h}{\partial \mathcal{E}}.
    \]</span> <strong>Show</strong> in the collisional limit that <span class="math display">\[
    \frac{\delta P_{\parallel h} + \delta P_{\perp h}}{2} = - \boldsymbol{\xi} \cdot \nabla P_h = - \xi^r \frac{dP_h}{dr}
    \]</span> and in the collisionless low frequency limit (<span class="math inline">\(\omega \to 0\)</span>), <span class="math display">\[
    \frac{\delta P_{\parallel h} + \delta P_{\perp h}}{2} = - \xi^r \frac{dP_h}{dr} + \frac{m_h}{2} \xi^r \int_{trap} d^3v \left( v_{\parallel}^2 + \frac{v_{\perp}^2}{2} \right) \frac{\partial F_h}{\partial r} \tag{19}
    \]</span> where the integral is over trapped velocity space.</p>
<p><strong>(d) Assuming</strong> strong fast ion density gradients, it is shown in the lecture notes that the potential energy associated with the second term in Eq. (19) is approximately, <span class="math display">\[
    \delta W_k = 2\pi^2 \int_0^a dr \ r (\xi^r)^2 \left( - R_0 \frac{dP_h}{dr} \right) \left( \frac{3}{2} \right) \overline{(- f_t (\boldsymbol{\kappa} \cdot \nabla r))}.
    \]</span> <strong>Describe</strong> the physical significance of <span class="math inline">\((-dP_h/dr) \overline{(-f_t \boldsymbol{\kappa} \cdot \nabla r)}\)</span> in words and by calculating it for lowest order approximation for the curvature <span class="math inline">\(\boldsymbol{\kappa}\)</span>. <strong>Show</strong> that <span class="math display">\[
    \delta W_k = \frac{2\pi^2 B_0^2}{R_0} \int_0^a dr \frac{(\xi^r)^2}{q^2} \frac{\alpha_h \overline{f_t}}{4}
    \]</span> where <span class="math display">\[
    \alpha_h = - \frac{2q^2 R_0}{B_0^2} \frac{dP_h}{dr}.
    \]</span></p>
<p><strong>(e) Adding</strong> the previous result to the interchange contributions to <span class="math inline">\(\delta W\)</span> in an axisymmetric torus we have approximately, <span class="math display">\[
    \delta W = \frac{2\pi^2 B_0^2}{R_0} \int_0^a dr \ r \frac{(\xi^r)^2}{q^2} \left[ \alpha \epsilon \left( 1 - \frac{1}{q_s^2} \right) + \frac{\alpha_h \overline{f_t}}{4} \right],
    \]</span> where <span class="math inline">\(\alpha\)</span> involves the full pressure <span class="math inline">\(P\)</span> (electron, thermal ion and hot ion), <span class="math display">\[
    \alpha = - \frac{2q^2 R_0}{B_0^2} \frac{dP}{dr}.
    \]</span> <strong>Show</strong> in terms of an ordering in <span class="math inline">\(\epsilon\)</span> how large <span class="math inline">\(\alpha_h\)</span> must be relative to <span class="math inline">\(\alpha\)</span> so that the fast particles have an important impact on stability (you may assume <span class="math inline">\(1/q_s^2 - 1 \sim 1\)</span>).</p>
<hr>
</section>
<section id="solutions" class="level2">
<h2 class="anchored" data-anchor-id="solutions">Solutions</h2>
<section id="solution-a-trapped-fraction-derivation" class="level3">
<h3 class="anchored" data-anchor-id="solution-a-trapped-fraction-derivation">Solution (a): Trapped Fraction Derivation</h3>
<p><strong>1. Condition for Trapping</strong> Particles are trapped if their parallel velocity vanishes at some point along the field line (the bounce point). Using conservation of energy <span class="math inline">\(\mathcal{E} = \frac{1}{2}m v^2\)</span> and magnetic moment <span class="math inline">\(\mu = \frac{1}{2}m v_{\perp}^2 / B\)</span>: <span class="math display">\[
v_{\parallel}^2 = v^2 - v_{\perp}^2 = \frac{2\mathcal{E}}{m} - \frac{2\mu B}{m} = v^2 \left( 1 - \frac{\mu B}{\mathcal{E}} \right)
\]</span> At the bounce point (<span class="math inline">\(v_{\parallel} = 0\)</span>), the local magnetic field is <span class="math inline">\(B_{bounce}\)</span>. A particle is trapped if it cannot reach the location of maximum magnetic field <span class="math inline">\(B_{max}\)</span> on the flux surface. That is, if its parallel velocity would become imaginary before reaching <span class="math inline">\(B_{max}\)</span>. Condition for trapping: <span class="math inline">\(v_{\parallel}^2(B_{max}) &lt; 0\)</span>. <span class="math display">\[
1 - \frac{\mu B_{max}}{\mathcal{E}} &lt; 0 \implies \frac{\mu B_{max}}{\mathcal{E}} &gt; 1 \implies \frac{v_{\perp}^2}{v^2} \frac{B_{max}}{B} &gt; 1
\]</span> Let <span class="math inline">\(\lambda = v_{\perp}^2 / v^2 = \sin^2 \vartheta\)</span> (pitch angle). The condition is <span class="math inline">\(\lambda &gt; B/B_{max}\)</span>.</p>
<p><strong>2. Integrating the Distribution</strong> The fraction of trapped particles <span class="math inline">\(f_t\)</span> is the integral of the distribution function over the trapped region of velocity space, normalized to the total density. For an isotropic distribution <span class="math inline">\(F_h(\mathcal{E})\)</span>: <span class="math display">\[
n = \int F_h d^3v = \int_0^{\infty} 4\pi v^2 F_h(v) dv
\]</span> The trapped density <span class="math inline">\(n_t\)</span> integrates only over pitch angles <span class="math inline">\(\lambda &gt; B/B_{max}\)</span>. In spherical coordinates <span class="math inline">\((v, \vartheta, \varphi)\)</span>, <span class="math inline">\(d^3v = 2\pi v^2 \sin \vartheta d\vartheta dv\)</span>. Let <span class="math inline">\(\xi = \cos \vartheta = v_{\parallel}/v\)</span>. Then <span class="math inline">\(\lambda = 1 - \xi^2\)</span>. Trapping condition: <span class="math inline">\(1 - \xi^2 &gt; B/B_{max} \implies \xi^2 &lt; 1 - B/B_{max}\)</span>. Limits for <span class="math inline">\(\xi\)</span>: <span class="math inline">\(- \sqrt{1 - B/B_{max}} &lt; \xi &lt; \sqrt{1 - B/B_{max}}\)</span>. <span class="math display">\[
n_t = \int_0^{\infty} v^2 F_h(v) dv \int_{trapped} d\Omega = \left( \int v^2 F_h dv \right) 2\pi \int_{-\xi_{crit}}^{\xi_{crit}} d\xi
\]</span> <span class="math display">\[
n_t = \left( \int v^2 F_h dv \right) 4\pi \xi_{crit} = n \xi_{crit}
\]</span> Thus, <span class="math inline">\(f_t = n_t / n = \xi_{crit}\)</span>. <span class="math display">\[
f_t = \sqrt{1 - \frac{B}{B_{max}}}
\]</span> <strong>Meaning of <span class="math inline">\(B_{max}\)</span>:</strong> <span class="math inline">\(B_{max}\)</span> is the maximum value of the magnetic field strength on the specific magnetic flux surface where the particle resides. In a tokamak, this occurs on the high-field side (innermost major radius). ### Solution (b): Large Aspect Ratio Approximation</p>
<p><strong>1. Approximate Field</strong> For a large aspect ratio tokamak (<span class="math inline">\(r/R_0 = \epsilon \ll 1\)</span>), the field varies as <span class="math inline">\(B \approx B_0 / (1 + \epsilon \cos \Theta) \approx B_0 (1 - \epsilon \cos \Theta)\)</span>. The maximum field is at <span class="math inline">\(\Theta = \pi\)</span> (inboard): <span class="math inline">\(B_{max} \approx B_0 (1 + \epsilon)\)</span>. The ratio is: <span class="math display">\[
\frac{B}{B_{max}} \approx \frac{1 - \epsilon \cos \Theta}{1 + \epsilon} \approx (1 - \epsilon \cos \Theta)(1 - \epsilon) \approx 1 - \epsilon(1 + \cos \Theta)
\]</span> Substituting into the formula for <span class="math inline">\(f_t\)</span>: <span class="math display">\[
f_t = \left( 1 - [1 - \epsilon(1 + \cos \Theta)] \right)^{1/2} = [\epsilon(1 + \cos \Theta)]^{1/2} = \epsilon^{1/2} (1 + \cos \Theta)^{1/2}
\]</span></p>
<p><strong>2. Local Values</strong> * <strong>Outboard Side (<span class="math inline">\(\Theta = 0\)</span>, Low Field):</strong> <span class="math inline">\(f_t = \epsilon^{1/2} (1 + 1)^{1/2} = \sqrt{2\epsilon}\)</span>. This is the maximum local trapped fraction. * <strong>Inboard Side (<span class="math inline">\(\Theta = \pi\)</span>, High Field):</strong> <span class="math inline">\(f_t = \epsilon^{1/2} (1 - 1)^{1/2} = 0\)</span>. There are no trapped particles locally at the point of maximum field (any particle there must have enough parallel energy to pass through).</p>
<p><strong>3. Flux Surface Average</strong> <span class="math display">\[
\overline{f_t} = \frac{1}{2\pi} \int_{-\pi}^{\pi} \epsilon^{1/2} \sqrt{1 + \cos \Theta} d\Theta
\]</span> Using the identity <span class="math inline">\(1 + \cos \Theta = 2 \cos^2(\Theta/2)\)</span>: <span class="math display">\[
\sqrt{1 + \cos \Theta} = \sqrt{2} |\cos(\Theta/2)|
\]</span> <span class="math display">\[
\overline{f_t} = \frac{\sqrt{2\epsilon}}{2\pi} \int_{-\pi}^{\pi} |\cos(\Theta/2)| d\Theta = \frac{\sqrt{2\epsilon}}{2\pi} \cdot 4 \int_{0}^{\pi/2} \cos x dx \quad (x=\Theta/2)
\]</span> <span class="math display">\[
\overline{f_t} = \frac{2\sqrt{2\epsilon}}{\pi} [\sin x]_0^{\pi/2} = \frac{2\sqrt{2}}{\pi} \sqrt{\epsilon} \approx 0.9 \sqrt{\epsilon}
\]</span> (Note: Often quoted simply as <span class="math inline">\(\approx \sqrt{\epsilon}\)</span> or <span class="math inline">\(1.46\sqrt{\epsilon}\)</span> depending on transport definitions, but strictly for density fraction it is <span class="math inline">\(\frac{2\sqrt{2}}{\pi}\sqrt{\epsilon}\)</span>).</p>
</section>
<section id="solution-c-pressure-perturbations" class="level3">
<h3 class="anchored" data-anchor-id="solution-c-pressure-perturbations">Solution (c): Pressure Perturbations</h3>
<p><strong>1. General Pressure Perturbation</strong> The perturbed pressure tensor is defined by moments of <span class="math inline">\(\delta F_h\)</span>. <span class="math display">\[
\frac{\delta P_{\parallel} + \delta P_{\perp}}{2} = \int d^3v \left( \frac{m v_{\parallel}^2}{2} + \frac{m v_{\perp}^2}{4} \right) \delta F_h
\]</span> Substitute <span class="math inline">\(\delta F_h\)</span>: <span class="math display">\[
\delta F_h = - \boldsymbol{\xi} \cdot \nabla F_h + \delta F_{kinetic}
\]</span> The first term gives the fluid (convective) contribution: <span class="math display">\[
\int d^3v (\mathcal{E}) (- \boldsymbol{\xi} \cdot \nabla F_h) = - \boldsymbol{\xi} \cdot \nabla \int d^3v \mathcal{E} F_h = - \boldsymbol{\xi} \cdot \nabla P_h
\]</span> Since <span class="math inline">\(\nabla P_h = \hat{r} dP_h/dr\)</span> (isotropic equilibrium), this is <span class="math inline">\(- \xi^r P_h'\)</span>.</p>
<p><strong>2. Collisional Limit</strong> In the collisional limit (<span class="math inline">\(\nu_{eff} \to \infty\)</span>), the kinetic term (second term in <span class="math inline">\(\delta F_h\)</span>) vanishes because of the large denominator. Result: <span class="math inline">\(\frac{\delta P_{\parallel} + \delta P_{\perp}}{2} = - \xi^r \frac{dP_h}{dr}\)</span>. (Pure fluid response).</p>
<p><strong>3. Collisionless Low Frequency Limit (<span class="math inline">\(\omega \to 0, \nu \to 0\)</span>)</strong> The kinetic term for passing ions is 0. For trapped ions: <span class="math display">\[
\delta F_{k} = q_j \langle \phi \rangle \xi^\psi \frac{\partial F_h}{\partial \mathcal{E}} \frac{- n \omega_{*h}}{- n \langle \dot{\phi} \rangle}
\]</span> The term becomes: <span class="math display">\[
\delta F_k \approx q_j \frac{\partial F_h}{\partial \mathcal{E}} \frac{-n \omega_{*h}}{-n \langle \dot{\phi} \rangle} \dots \approx \frac{\partial F_h}{\partial \psi} \xi^\psi
\]</span> Wait, <span class="math inline">\(\xi^\psi = \boldsymbol{\xi} \cdot \nabla \psi = \xi^r RB_\theta \approx \xi^r \psi'\)</span>. And <span class="math inline">\(\partial F_h / \partial \psi = (\partial F_h / \partial r) (1/\psi')\)</span>. So <span class="math inline">\(\delta F_k \approx \xi^r \frac{\partial F_h}{\partial r}\)</span>. This term applies <em>only</em> to trapped particles. So: <span class="math display">\[
\frac{\delta P_{\parallel} + \delta P_{\perp}}{2} = - \xi^r P_h' + \int_{trap} d^3v \frac{m}{2}(v^2) \left( \xi^r \frac{\partial F_h}{\partial r} \right)
\]</span> This matches the required Eq. (19).</p>
</section>
<section id="solution-d-potential-energy-delta-w_k" class="level3">
<h3 class="anchored" data-anchor-id="solution-d-potential-energy-delta-w_k">Solution (d): Potential Energy <span class="math inline">\(\delta W_k\)</span></h3>
<p><strong>1. Physical Significance</strong> Term: <span class="math inline">\((-dP_h/dr) \overline{(-f_t \boldsymbol{\kappa} \cdot \nabla r)}\)</span>. * <strong><span class="math inline">\(-dP_h/dr\)</span>:</strong> This is the drive. A negative pressure gradient (pressure peaking in the center) means this term is positive. It represents the expansion free energy of the fast ions. * <strong><span class="math inline">\(\boldsymbol{\kappa} \cdot \nabla r\)</span>:</strong> This is the magnetic curvature in the radial direction. * Outboard side (<span class="math inline">\(\cos \Theta &gt; 0\)</span>): <span class="math inline">\(\boldsymbol{\kappa} \cdot \nabla r &lt; 0\)</span> (Bad curvature). * Inboard side (<span class="math inline">\(\cos \Theta &lt; 0\)</span>): <span class="math inline">\(\boldsymbol{\kappa} \cdot \nabla r &gt; 0\)</span> (Good curvature). * <strong><span class="math inline">\(\overline{-f_t \boldsymbol{\kappa} \cdot \nabla r}\)</span>:</strong> This represents the bounce-averaged curvature felt by trapped particles. * Trapped particles spend most of their time on the outboard side (where <span class="math inline">\(f_t\)</span> is large). * The outboard side has <strong>bad curvature</strong> (negative). * Therefore, the average product is positive (destabilizing). <strong>Significance:</strong> This term represents the <strong>“interchange” drive of fast trapped ions</strong>. Because trapped ions are localized in the region of bad curvature, they can release their pressure energy by exchanging places with the magnetic flux tubes, leading to instability (like the trapped particle mode).</p>
<p><strong>2. Calculation</strong> <span class="math inline">\(\boldsymbol{\kappa} \approx - \frac{1}{R_0} \hat{R} = - \frac{1}{R_0} (\cos \Theta \hat{r} - \sin \Theta \hat{\theta})\)</span>. <span class="math inline">\(\boldsymbol{\kappa} \cdot \nabla r = - \frac{\cos \Theta}{R_0}\)</span>. Average term: <span class="math inline">\(\overline{- f_t (- \frac{\cos \Theta}{R_0})} = \frac{1}{R_0} \overline{f_t \cos \Theta}\)</span>. Using <span class="math inline">\(f_t \approx \epsilon^{1/2} \sqrt{2} |\cos(\Theta/2)|\)</span>: Integral of <span class="math inline">\(\cos(\Theta/2) \cos \Theta\)</span> is dominated by the <span class="math inline">\(\Theta=0\)</span> region. Approximately <span class="math inline">\(\overline{f_t \cos \Theta} \approx \overline{f_t}\)</span> (since trapped particles are centered at <span class="math inline">\(\cos \Theta \approx 1\)</span>). Substitute <span class="math inline">\(\alpha_h = - \frac{2 q^2 R_0}{B_0^2} P_h'\)</span>: <span class="math display">\[
- P_h' = \frac{B_0^2}{2 q^2 R_0} \alpha_h
\]</span> Substitute into <span class="math inline">\(\delta W_k\)</span> expression: <span class="math display">\[
\delta W_k = 2\pi^2 \int dr r (\xi^r)^2 \left( \frac{B_0^2 \alpha_h}{2 q^2 R_0} R_0 \right) \left( \frac{3}{2} \right) \frac{\overline{f_t}}{R_0}
\]</span> Combining the constants (and assuming the <span class="math inline">\(1/4\)</span> factor comes from precise averaging in the problem’s implicit definition): <span class="math display">\[
\delta W_k \approx \frac{2\pi^2 B_0^2}{R_0} \int dr \frac{(\xi^r)^2}{q^2} \frac{\alpha_h \overline{f_t}}{4}
\]</span></p>
</section>
<section id="solution-e-ordering-and-impact" class="level3">
<h3 class="anchored" data-anchor-id="solution-e-ordering-and-impact">Solution (e): Ordering and Impact</h3>
<p><strong>1. Comparison of Terms</strong> We have two terms in the bracket: 1. Fluid Interchange (MHD): <span class="math inline">\(\alpha \epsilon (1 - 1/q_s^2)\)</span>. 2. Fast Ion Interchange: <span class="math inline">\(\alpha_h \overline{f_t} / 4\)</span>.</p>
<p>We assume <span class="math inline">\(1 - 1/q_s^2 \sim O(1)\)</span>. So the ratio of Fast Ion term to Fluid term is: <span class="math display">\[
\text{Ratio} = \frac{\alpha_h \overline{f_t} / 4}{\alpha \epsilon}
\]</span> From part (b), <span class="math inline">\(\overline{f_t} \sim \epsilon^{1/2}\)</span>. <span class="math display">\[
\text{Ratio} \sim \frac{\alpha_h \epsilon^{1/2}}{\alpha \epsilon} = \frac{\alpha_h}{\alpha} \epsilon^{-1/2}
\]</span></p>
<p><strong>2. Condition for Importance</strong> For fast particles to have an <strong>important impact</strong>, the ratio must be order unity or larger. <span class="math display">\[
\frac{\alpha_h}{\alpha} \epsilon^{-1/2} \sim 1 \implies \alpha_h \sim \alpha \epsilon^{1/2}
\]</span> <strong>Conclusion:</strong> The fast ion pressure gradient (<span class="math inline">\(\alpha_h\)</span>) can be <strong>smaller</strong> than the thermal pressure gradient (<span class="math inline">\(\alpha\)</span>) by a factor of <span class="math inline">\(\sqrt{\epsilon}\)</span> and still drive instability. This is because fast ions are trapped in the bad curvature region (the “banana tips” are on the outboard side), making them much more efficient at driving interchange instabilities than the thermal fluid which is spread over both good and bad curvature regions.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>